---
group: graphql
title: Klarna payment method
contributor_name: Klarna
contributor_link: https://www.klarna.com/
---

Klarna Payments enables your consumers to try before they buy, finance purchases on your store with Klarna, or let them pay directly. Klarna offers these payment methods through a widget that you can add inline on your checkout page.

## Klarna payments workflow

[diagram-placeholder]

Klarna payments require cart information to initiate the session. For this reason, the below steps can be executed only after a cart has been created.

See the [GraphQL Magento Tutorial]({{ site.baseurl }}/graphql/tutorials/checkout/index.html) to create a cart.

1. The PWA client calls the `createKlarnaPaymentsSession` mutation to generate the `client_token` and retrieve the `payment_categories`.

   -  This step can be executed at any time after the cart is created. However, it is recommended to have at least the billing address, shipping address, products, and shipping method set on the cart.

1. Magento forwards the request to Klarna.

1. Klarna returns the `client_token` and `payment_categories`.

1. Magento forwards the token to the client.

1. The client sends the query to retrieve the available payment methods.

   -  Magento must always retrieve the latest status information from Klarna before returning the Klarna payments method as an option to the customer. This is important to ensure that the customer is always shown the latest available payment options.

1. Magento returns the available payment methods, including the Klarna payment method.

1. The PWA client renders the Klarna payment widget.

   -  The PWA client uses the `client_token` and `payment_categories` to initialize the Klarna Payments JS SDK.

1. The PWA client sends the authorize directly to Klarna.

   -  On the checkout page, the customer selects Klarna as the payment method and clicks **Place Order**. When this happens, the PWA client must send the `authorize()` call to Klarna. Then the shopper follows the authorization steps on the Klarna inline modal. During this phase the communication between the PWA client and Klarna is handled directly by the Klarna Payments JS SDK.

1. Klarna returns the `authorization_token` in response to the authorize call.

1. Set the Payment Method providing the `authorization_token` as part of the `setPaymentMethodOnCart` mutation.

   -  The client uses the `setPaymentMethodOnCart` mutation to set the payment method to `klarna_*`. The `authorization_token` is passed in the `klarna` object.

1. Magento returns an updated `cart` object.

1. The PWA client runs the `placeOrder` mutation.

1. Magento sends the place order request to Klarna.

1. Klarna sends the response to Magento.

1. Magento creates an order and sends an order ID in response to the `placeOrder` mutation.

## How to handle cart updates

During the purchase flow, the cart can be update by adding additional products, applying coupons, and changing the billing or shipping address. All these events might cause a change in Klarna options for the specific customer.

In order to always present customers with the latest available payment options provided by Klarna, the PWA client must:

-  Perform a cart update.
-  Send the query to retrieve the latest available payment methods. This will trigger a subsequent request to Klarna with the latest information available from the cart. Note that the new list of payment methods returned might contain different options for the customer.
-  Reload the widget on the client side as explained here.

The following diagram describes the workflow:

[diagram-placeholder]

## setPaymentMethodOnCart mutation

When you set the payment method to Klarna in the setPaymentMethodOnCart mutation, the payment_method object must contain a klarna object.

### klarna object

The klarna object must contain the following attributes:

Attribute |  Data Type | Description
--- | --- | ---
`authorization_token` | String! | The one-time authorization token generated by the Klarna payment gateway based on customer details collected during the purchase flow

## Example usage

The following example shows the  `setPaymentMethodOnCart` mutation constructed for the Klarna payment method.

**Request:**

```text
mutation {
  setPaymentMethodOnCart(input: {
    cart_id: "3WxC8gQn4Fbo55yqVLSiUFJ9fmEwnlxG"
    payment_method: {
      code: "klarna_pay_later"
      klarna: {
        authorization_token: "e9abc610-6748-256f-a506-355626551326"
      }
    }
  }) {
  cart {
    selected_payment_method {
      code
    }
  }
}

```

**Response:**

```json
{
  "data": {
    "setPaymentMethodOnCart": {
     "cart": {
       "selected_payment_method": {
         "code": "klarna_pay_later"
        }
      }
    }
  }
}
```
